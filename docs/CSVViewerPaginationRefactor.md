# CSV Viewer 分页重构文档

## 概述

CSV Viewer 已成功重构以支持大数据量文件的分页加载和预览。当数据行数超过 20 万行时，系统会自动启用分页模式。

## 核心特性

### 1. 自动分页
- **触发条件**：CSV 文件行数 > 200,000 行
- **分页大小**：每页 200,000 行
- **智能加载**：只加载当前浏览的页面数据

### 2. 预加载机制
- **当前页**：立即加载并显示
- **下一页**：后台静默预加载，提升翻页速度
- **缓存管理**：已加载的页面会被缓存，避免重复加载

### 3. 缩略图预览
- **降采样**：每页生成约 1000 个采样点的缩略图
- **可视化**：使用 SVG 迷你图表显示数据趋势
- **交互**：点击缩略图直接跳转到对应页面
- **状态显示**：
  - 当前页：高亮显示
  - 已加载：显示数据预览
  - 未加载：显示占位符

### 4. 进度指示器
- **实时进度**：显示加载进度百分比
- **详细信息**：当前行数 / 总行数
- **用户友好**：模态遮罩 + 半透明背景

### 5. 内存优化
- **流式解析**：不一次性读取整个文件
- **按需加载**：只解析当前需要的数据范围
- **缓存限制**：最多缓存当前页和下一页

## 技术实现

### 新增文件

#### csvPagination.ts
分页管理核心逻辑：
- `calculatePagination()` - 计算分页信息
- `parseCSVPage()` - 流式解析指定页
- `quickCountRows()` - 快速统计总行数
- `sampleForThumbnail()` - 生成缩略图采样数据

#### ThumbnailGrid.tsx
缩略图网格组件：
- 响应式网格布局
- SVG 迷你图表渲染
- 页面状态管理

#### ProgressBar.tsx
进度条组件：
- 模态显示
- 实时进度更新
- 平滑动画效果

### 重构内容

#### CSVV.tsx 主要改动
1. **状态管理**
   - 添加分页状态 `pagination`
   - 添加缩略图数据 `thumbnails`
   - 添加页面缓存 `cachedPages`
   - 添加加载进度 `loadingProgress`

2. **文件加载**
   - `handleFileSelection()` - 异步处理，支持大小文件判断
   - `handleSmallFile()` - 小文件直接全部加载
   - `handleLargeFile()` - 大文件分页加载

3. **页面加载**
   - `loadPage()` - 加载指定页数据
   - `preloadPage()` - 后台预加载
   - `generateAllThumbnails()` - 生成所有缩略图

4. **UI 更新**
   - 添加缩略图网格显示
   - 添加进度条显示
   - 优化状态提示

## 使用方法

### 加载文件
1. 拖拽或选择 CSV 文件
2. 系统自动检测文件大小
3. 大文件自动启用分页模式

### 浏览数据
- **小文件（≤20万行）**：正常浏览，无分页
- **大文件（>20万行）**：
  - 首次加载显示第 1 页
  - 使用下方缩略图快速跳转
  - 翻页时显示加载进度

### 缩略图操作
- **查看**：鼠标悬停显示详细信息
- **跳转**：点击缩略图加载对应页面
- **识别**：当前页高亮显示

## 性能优化

### 内存使用
- 小文件（≤20万行）：全部加载到内存
- 大文件（>20万行）：
  - 仅加载当前页：~200,000 行
  - 预加载下一页：~200,000 行
  - 总内存占用：约 400,000 行数据

### 解析性能
- 使用流式解析器，避免阻塞 UI
- 使用 setTimeout(0) 将解析任务分片
- 进度回调每 1000 行更新一次

### 缩略图生成
- 后台异步生成，不阻塞主流程
- 每 5 页暂停一次，避免长时间阻塞
- 采样率约 1:200，大幅减少计算量

## 兼容性

### 向后兼容
- 小文件保持原有行为
- 所有原有功能正常工作
- 图表渲染逻辑不变

### 分隔符切换
- 自动重新计算分页
- 清空缓存重新加载
- 保持当前选择的列

## 已知限制

1. **X 轴范围**：分页模式下 X 轴范围基于页内数据
2. **下采样**：图表下采样仅作用于当前页数据
3. **搜索过滤**：暂不支持跨页搜索和过滤

## 未来改进

1. 虚拟滚动支持
2. 跨页搜索功能
3. 分页导出功能
4. 更多缩略图样式
5. 自定义分页大小

## 示例

### 文件大小与分页
- 10万行：不分页
- 20万行：不分页（临界值）
- 30万行：2页（0-200k, 200k-300k）
- 100万行：5页
- 200万行：10页

### 内存占用估算
假设平均每行 100 字节：
- 20万行：~20MB
- 40万行缓存（当前+下一页）：~40MB
- 远小于一次性加载全部数据

## 技术栈

- **SolidJS**：响应式状态管理
- **TypeScript**：类型安全
- **CSS Modules**：样式隔离
- **SVG**：矢量图形渲染
